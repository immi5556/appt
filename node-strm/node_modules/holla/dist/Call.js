// Generated by CoffeeScript 1.6.2
(function() {
  var Call, EventEmitter, shims,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  shims = require('./shims');

  EventEmitter = require('emitter');

  Call = (function(_super) {
    __extends(Call, _super);

    function Call(parent, user, isCaller) {
      var _this = this;

      this.parent = parent;
      this.user = user;
      this.isCaller = isCaller;
      this.initSDP = __bind(this.initSDP, this);
      this.unmute = __bind(this.unmute, this);
      this.mute = __bind(this.mute, this);
      this.end = __bind(this.end, this);
      this.releaseStream = __bind(this.releaseStream, this);
      this.decline = __bind(this.decline, this);
      this.answer = __bind(this.answer, this);
      this.chat = __bind(this.chat, this);
      this.duration = __bind(this.duration, this);
      this.ready = __bind(this.ready, this);
      this.addStream = __bind(this.addStream, this);
      this.createConnection = __bind(this.createConnection, this);
      this.processRemoteSDP = __bind(this.processRemoteSDP, this);
      this.startTime = new Date;
      this.socket = this.parent.ssocket;
      this.pc = this.createConnection();
      if (this.isCaller) {
        this.socket.write({
          type: "offer",
          to: this.user
        });
      }
      this.emit("calling");
      this.parent.on("answer." + this.user, function(accepted) {
        if (!accepted) {
          return _this.emit("rejected");
        }
        _this.emit("answered");
        if (_this.isCaller) {
          return _this.initSDP();
        }
      });
      this.parent.on("candidate." + this.user, function(candidate) {
        return _this.pc.addIceCandidate(new shims.IceCandidate(candidate));
      });
      this.parent.on("sdp." + this.user, this.processRemoteSDP);
      this.parent.on("hangup." + this.user, function() {
        return _this.emit("hangup");
      });
      this.parent.on("chat." + this.user, function(msg) {
        return _this.emit("chat", msg);
      });
    }

    Call.prototype.processRemoteSDP = function(desc) {
      var err, succ,
        _this = this;

      if (this.pc.remoteDescription) {
        return;
      }
      console.log("" + this.isCaller + " remote", desc);
      desc.sdp = shims.processSDPIn(desc.sdp);
      err = function(e) {
        throw e;
      };
      succ = function() {
        _this.emit("sdp");
        if (!_this.isCaller) {
          return _this.initSDP();
        }
      };
      return this.pc.setRemoteDescription(new shims.SessionDescription(desc), succ, err);
    };

    Call.prototype.createConnection = function() {
      var pc,
        _this = this;

      pc = new shims.PeerConnection(shims.PeerConnConfig, shims.constraints);
      pc.onconnecting = function() {
        _this.emit('connecting');
      };
      pc.onopen = function() {
        _this.emit('connected');
      };
      pc.onicecandidate = function(evt) {
        if (evt.candidate) {
          _this.socket.write({
            type: "candidate",
            to: _this.user,
            args: {
              candidate: evt.candidate
            }
          });
        }
      };
      pc.onaddstream = function(evt) {
        _this.remoteStream = evt.stream;
        _this._ready = true;
        _this.emit("ready", _this.remoteStream);
      };
      pc.onremovestream = function(evt) {
        console.log("removestream", evt);
        _this.end();
        _this.emit('hangup');
      };
      return pc;
    };

    Call.prototype.addStream = function(s) {
      this.localStream = s;
      this.pc.addStream(s);
      return this;
    };

    Call.prototype.ready = function(fn) {
      if (this._ready) {
        fn(this.remoteStream);
      } else {
        this.once('ready', fn);
      }
      return this;
    };

    Call.prototype.duration = function() {
      var e, s;

      if (this.endTime != null) {
        s = this.endTime.getTime();
      }
      if (s == null) {
        s = Date.now();
      }
      e = this.startTime.getTime();
      return (s - e) / 1000;
    };

    Call.prototype.chat = function(msg) {
      this.parent.chat(this.user, msg);
      return this;
    };

    Call.prototype.answer = function() {
      this.startTime = new Date;
      this.socket.write({
        type: "answer",
        to: this.user,
        args: {
          accepted: true
        }
      });
      return this;
    };

    Call.prototype.decline = function() {
      this.socket.write({
        type: "answer",
        to: this.user,
        args: {
          accepted: false
        }
      });
      return this;
    };

    Call.prototype.releaseStream = function() {
      return this.localStream.stop();
    };

    Call.prototype.end = function() {
      this.endTime = new Date;
      try {
        this.pc.close();
      } catch (_error) {}
      this.socket.write({
        type: "hangup",
        to: this.user
      });
      this.emit("hangup");
      return this;
    };

    Call.prototype.mute = function() {
      var track, _i, _len, _ref, _results;

      _ref = this.localStream.getAudioTracks();
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        track = _ref[_i];
        _results.push(track.enabled = false);
      }
      return _results;
    };

    Call.prototype.unmute = function() {
      var track, _i, _len, _ref, _results;

      _ref = this.localStream.getAudioTracks();
      _results = [];
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        track = _ref[_i];
        _results.push(track.enabled = true);
      }
      return _results;
    };

    Call.prototype.initSDP = function() {
      var done, err,
        _this = this;

      done = function(desc) {
        desc.sdp = shims.processSDPOut(desc.sdp);
        console.log("" + _this.isCaller + " local", desc);
        _this.pc.setLocalDescription(desc);
        return _this.socket.write({
          type: "sdp",
          to: _this.user,
          args: desc
        });
      };
      err = function(e) {
        throw e;
      };
      if (this.isCaller) {
        return this.pc.createOffer(done, err, shims.constraints);
      }
      if (this.pc.remoteDescription) {
        return this.pc.createAnswer(done, err, shims.constraints);
      } else {
        return this.once("sdp", function() {
          return _this.pc.createAnswer(done, err, shims.constraints);
        });
      }
    };

    return Call;

  })(EventEmitter);

  module.exports = Call;

}).call(this);
